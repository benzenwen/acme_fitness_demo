namespace: acme-fitness

cart:
  defines: runnable
  inherits: acmefit/cart
  affinity:
    name: m1683-services
  depends:
    wait-for:
      runnables:
        - acme-fitness/user
        - acme-fitness/jaeger
        - acme-fitness/redis-db
      timeout: 60
  variables:
    user-host: <- get-hostname("acme-fitness/user", "user")
    jaeger-agent-host: <- get-hostname("acme-fitness/jaeger", "jaeger")
    redis-host: <- get-hostname("acme-fitness/redis-db", "redis-db")

catalog:
  defines: runnable
  inherits: acmefit/catalog
  affinity:
    name: m1683-services
  depends:
    wait-for:
      runnables:
        - acme-fitness/user
        - acme-fitness/jaeger
        - acme-fitness/catalog-db
      timeout: 60
  variables:
    catalog-db-password: secret
    catalog-db-port: '27017'
    catalog-db-username: mongoadmin
    catalog-port: '8082'
    catalog-version: v1
    jaeger-agent-port: '6831'
    users-port: '8083'
    users-host: <- get-hostname("acme-fitness/user", "user")
    jaeger-agent-host: <- get-hostname("acme-fitness/jaeger", "jaeger")
    catalog-db-host: <- get-hostname("acme-fitness/catalog-db", "catalog-db")

order:
  defines: runnable
  inherits: acmefit/order
  affinity:
    name: m1683-checkout
  depends:
    wait-for:
      runnables:
        - acme-fitness/user
        - acme-fitness/jaeger
        - acme-fitness/payment
        - acme-fitness/postgres
      timeout: 60
  variables:
    auth-mode: '1'
    jaeger-agent-port: '6831'
    order-auth-db: postgres
    order-db-password: password
    order-db-port: '5432'
    order-db-username: postgres
    order-port: '6000'
    payment-port: '9000'
    user-port: '8083'
    user-host: <- get-hostname("acme-fitness/user", "user")
    jaeger-agent-host: <- get-hostname("acme-fitness/jaeger", "jaeger")
    payment-host: <- get-hostname("acme-fitness/payment", "payment")
    order-db-host: <- get-hostname("acme-fitness/postgres", "postgres")

payment:
  defines: runnable
  inherits: acmefit/payment
  affinity:
    name: m1683-checkout
  depends:
    wait-for:
      runnables:
        - acme-fitness/user
        - acme-fitness/jaeger
      timeout: 60
  variables:
    jaeger-agent-port: '6832'
    payment-port: '9000'
    users-port: '8083'
    users-host: <- get-hostname("acme-fitness/user", "user")
    jaeger-agent-host: <- get-hostname("acme-fitness/jaeger", "jaeger")

user:
  defines: runnable
  inherits: acmefit/user
  affinity:
    name: m1683-users
  depends:
    wait-for:
      runnables:
        - acme-fitness/user-db
        - acme-fitness/jaeger
        - acme-fitness/user-redis-db
      timeout: 60
  variables:
    jaeger-agent-port: '6831'
    redis-db-password: secret
    redis-db-port: '6379'
    users-db-password: secret
    users-db-port: '27017'
    users-db-username: mongoadmin
    users-port: '8083'
    users-db-host: <- get-hostname("acme-fitness/user-db", "user-db")
    jaeger-agent-host: <- get-hostname("acme-fitness/jaeger", "jaeger")
    redis-db-host: <- get-hostname("acme-fitness/user-redis-db", "user-redis-db")

jaeger:
  defines: runnable
  inherits: acmefit/jaeger
  affinity:
    name: m1683-monitoring

front-end:
  defines: runnable
  inherits: acmefit/front-end
  affinity:
    name: m1683-front
  depends:
    wait-for:
      runnables:
        - acme-fitness/user
        - acme-fitness/catalog
        - acme-fitness/cart
        - acme-fitness/order
        - acme-fitness/jaeger
      timeout: 60
  variables:
    cart-port: '5000'
    catalog-port: '8082'
    jaeger-agent-port: '6832'
    order-port: '6000'
    port: '3000'
    users-port: '8083'
    users-host: <- get-hostname("acme-fitness/user", "user")
    catalog-host: <- get-hostname("acme-fitness/catalog", "catalog")
    cart-host: <- get-hostname("acme-fitness/cart", "cart")
    order-host: <- get-hostname("acme-fitness/order", "order")
    jaeger-agent-host: <- get-hostname("acme-fitness/jaeger", "jaeger")

catalog-db:
  defines: runnable
  inherits: acmefit/catalog-db
  affinity:
    name: m1683-services
  variables:
    mongo-initdb-database: acmefit
    mongo-initdb-root-password: secret
    mongo-initdb-root-username: mongoadmin

postgres:
  defines: runnable
  inherits: acmefit/postgres
  affinity:
    name: m1683-checkout
  variables:
    postgres-db: postgres
    postgres-password: password
    postgres-user: postgres

user-db:
  defines: runnable
  inherits: acmefit/user-db
  affinity:
    name: m1683-users
  variables:
    mongo-initdb-database: acmefit
    mongo-initdb-root-password: secret
    mongo-initdb-root-username: mongoadmin

user-redis-db:
  defines: runnable
  inherits: acmefit/user-redis-db
  affinity:
    name: m1683-users
  variables:
    redis-password: secret

redis-db:
  defines: runnable
  inherits: acmefit/redis-db
  affinity:
    name: m1683-services
  variables:
    redis-password: secret

system:
  defines: process-group
  runnable-list:
    - acme-fitness/cart
    - acme-fitness/catalog
    - acme-fitness/order
    - acme-fitness/payment
    - acme-fitness/user
    - acme-fitness/jaeger
    - acme-fitness/front-end
    - acme-fitness/catalog-db
    - acme-fitness/postgres
    - acme-fitness/user-db
    - acme-fitness/user-redis-db
    - acme-fitness/redis-db
  nodes:
    m1683-checkout:
      provider: aws
      region: eu-west-1
      tag: default
      instance-type: t3.medium
      disk-size: 30
      disk-type: ssd
    m1683-services:
      provider: gcp
      region: europe-west1
      tag: default
      instance-type: n2-standard-4
      disk-size: 30
      disk-type: ssd
      zone: europe-west1-b
    m1683-front:
      provider: digitalocean
      region: ams3
      tag: default
      instance-type: s-2vcpu-4gb
      disk-size: 30
      disk-type: ssd
    m1683-monitoring:
      provider: digitalocean
      region: ams3
      tag: default
      instance-type: s-2vcpu-4gb
      disk-size: 30
      disk-type: ssd
    m1683-users:
      provider: gcp
      region: europe-west1
      tag: default
      instance-type: e2-standard-4
      disk-size: 30
      disk-type: ssd
      zone: europe-west1-b
